<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/_layout :: layout(~{::pageContent}, ~{::pageCss}, ~{::pageJs}, ${title})}">

<th:block th:fragment="pageCss">
    <style>
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .remove-option-btn {
            color: red;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }
    </style>
</th:block>

<th:block th:fragment="pageContent">
    <div class="container py-5">
        <div class="card shadow p-4">
            <h4 class="mb-3" th:text="${pageTitle}"></h4>

            <form th:action="@{'/admin/update-quiz-question/' + ${quizId}}"
                  method="post"
                  th:object="${question}"
                  id="quizForm">

                <!-- Hidden ID -->
                <input type="hidden" th:field="*{id}" />

                <!-- Question -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Question</label>
                    <input type="text" th:field="*{question}"
                           class="form-control" placeholder="Enter your question" required maxlength="400">
                    <div class="text-danger" th:if="${#fields.hasErrors('question')}" th:errors="*{question}"></div>
                </div>

                <hr>

                <!-- Options container -->
                <div id="optionsContainer">
                    <label class="form-label fw-semibold">Options</label>

                    <!-- Existing options -->
                    <div th:each="opt, iterStat : *{options}"
                         class="option-item"
                         th:attr="data-index=${iterStat.index}">
                        <input type="text"
                               th:name="'options[' + ${iterStat.index} + '].option'"
                               th:value="${opt.option}"
                               class="form-control w-50"
                               placeholder="Enter option text"
                               maxlength="200"
                               required>

                        <div class="form-check">
                            <input type="radio"
                                   name="correctOption"
                                   class="form-check-input"
                                   th:value="${iterStat.index}"
                                   th:checked="${opt.correct}">
                            <label class="form-check-label">Correct</label>
                        </div>

                        <input type="hidden"
                               th:name="'options[' + ${iterStat.index} + '].correct'"
                               th:value="${opt.correct}" />

                        <span class="remove-option-btn">&times;</span>
                    </div>
                </div>

                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addOptionBtn">+ Add Option</button>

                <hr>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-danger" id="deleteQuestionBtn">Delete Question</button>
                    <button type="submit" class="btn btn-success">Save Question</button>
                </div>
            </form>
        </div>
    </div>
</th:block>

<th:block th:fragment="pageJs">
    <script>
        $(function () {
            // Initialize index with current options count
            let optionIndex = $('#optionsContainer .option-item').length;

            // Add new option
            $('#addOptionBtn').click(function () {
                const optionHtml = `
                    <div class="option-item" data-index="${optionIndex}">
                        <input type="text"
                            name="options[${optionIndex}].option"
                            class="form-control w-50"
                            placeholder="Enter option text"
                            maxlength="200" required>

                        <div class="form-check">
                            <input type="radio"
                                name="correctOption"
                                class="form-check-input"
                                value="${optionIndex}">
                            <label class="form-check-label">Correct</label>
                        </div>

                        <input type="hidden" name="options[${optionIndex}].correct" value="false">
                        <span class="remove-option-btn">&times;</span>
                    </div>
                `;
                $('#optionsContainer').append(optionHtml);
                optionIndex++;
            });

            // Remove option
            $(document).on('click', '.remove-option-btn', function () {
                $(this).closest('.option-item').remove();
            });

            // Handle correct radio selection
            $(document).on('change', 'input[name="correctOption"]', function () {
                const selected = $(this).val();
                $('.option-item').each(function () {
                    const idx = $(this).data('index');
                    const hidden = $(this).find(`input[name="options[${idx}].correct"]`);
                    hidden.val(idx == selected);
                });
            });

            // Delete (clear form)
            $('#deleteQuestionBtn').click(function () {
                if (confirm("Are you sure you want to clear this question?")) {
                    $('#quizForm')[0].reset();
                    $('#optionsContainer').empty();
                }
            });
        });
    </script>
</th:block>
</html>
